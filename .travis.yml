language: android
android:
  components:
  - platform-tools
  - tools
  - build-tools-22.0.1
  - android-22
sudo: false

env:
  global:
  - secure: "KdYU7nWHrw5SdkKqiy/bkephmervpWzEl4YkfIFq6oFi9BJQoT6ty0T81dNXc4c0l9lo4gCaxJlDS2JqINoXiLWDQGKejG1F4l+KrfYz8iZImLlb2byVgAIdC0/vkRZrEtvBFeKTwhR04e+e1NCUcUTt/OImgzhjD025OtRI/MA="

before_install:
  - openssl aes-256-cbc -K $encrypted_9388caed6534_key -iv $encrypted_9388caed6534_iv -in secrets.tar.enc -out secrets.tar -d
  - tar -xvf secrets.tar

install:
  # Use nvm to install and select version 0.12 of nodejs instead of the default 0.10
  - nvm install 0.12
  - npm install -g cordova
  - npm install -g ionic
  - npm install -g gulp
  - gem install sass
  - npm install
  - bower install
  # TODO: Move to before_deploy once proven that this command works on Travis
  - pip install --user --upgrade google-api-python-client

script:
  - gulp build -b
  - gulp unittest
  - gulp e2e-tests-headless

  - cordova platform add android
  # Either try to build with gradle but without the gradle daemon, works intermittently
  #- gulp build-android-no-gradle-daemon -b
  # Or build with ant, old skool
  - ANDROID_BUILD=ant cordova build --release android
  - mkdir -p builds/android
  - cp platforms/android/bin/MainActivity-release-unsigned.apk builds/android/pottypottypotty-release-unsigned.apk

before_deploy:
  # Deploy apk - todo: add this copy to gulpfile for build-android (but not if we're doing ant builds!)
  # Sign build with KEY_PASS env variable
  # - mkdir -p builds/android
  # - cp platforms/android/build/outputs/apk/android-debug.apk builds/android/pottypottypotty-debug.apk

deploy:
  provider: releases
  api_key:
    secure: SKYWxcbR6iILEPl+z8kmCNLWz8AvXpvVN4hix6y+ISfMPZQL1lZheE7qEUVbPX4HdHFHcw0d2AyE7AQXYzxBspq2GLTWHZjjn6jakRXGqEiIQytdlUc8ddcuG17IAKvy82SPDRz/9kyIuaPrMIP35fG8LjTFlvxV2EuQCZTqfII=
  file: builds/android/pottypottypotty-debug.apk
  skip_cleanup: true
  on:
    tags: true
    repo: charlesarmitage/PottyPottyPotty
